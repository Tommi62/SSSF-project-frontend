{"ast":null,"code":"import _regeneratorRuntime from\"/Users/tommivainio/Projektit/chatApp/my-app/node_modules/babel-preset-react-app/node_modules/@babel/runtime/regenerator\";import _asyncToGenerator from\"/Users/tommivainio/Projektit/chatApp/my-app/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/asyncToGenerator\";import _slicedToArray from\"/Users/tommivainio/Projektit/chatApp/my-app/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/slicedToArray\";import{Button,Grid,List,TextField}from'@material-ui/core';import SendIcon from'@material-ui/icons/Send';import{IconButton}from'@material-ui/core';import{useContext,useEffect,useState}from'react';import{MediaContext}from'../contexts/mediaContext';import{useChats,useUsers}from'../hooks/apiHooks';import Message from'../components/message';import useWindowDimensions from'../hooks/windowDimensionsHook';import{useRef}from'react';import{jsx as _jsx}from\"react/jsx-runtime\";import{jsxs as _jsxs}from\"react/jsx-runtime\";import{Fragment as _Fragment}from\"react/jsx-runtime\";var Thread=function Thread(_ref){var messages=_ref.messages,id=_ref.id,websocket=_ref.websocket,messageAmount=_ref.messageAmount,setMessageAmount=_ref.setMessageAmount;var _useState=useState(''),_useState2=_slicedToArray(_useState,2),message=_useState2[0],setMessage=_useState2[1];var _useState3=useState(0),_useState4=_slicedToArray(_useState3,2),messageId=_useState4[0],setMessageId=_useState4[1];var _useState5=useState(false),_useState6=_slicedToArray(_useState5,2),showButton=_useState6[0],setShowButton=_useState6[1];var _useState7=useState([]),_useState8=_slicedToArray(_useState7,2),usernames=_useState8[0],setUsernames=_useState8[1];var _useState9=useState([]),_useState10=_slicedToArray(_useState9,2),moreMessages=_useState10[0],setMoreMessages=_useState10[1];var _useState11=useState(false),_useState12=_slicedToArray(_useState11,2),loadMore=_useState12[0],setLoadMore=_useState12[1];var _useState13=useState(false),_useState14=_slicedToArray(_useState13,2),messageScroll=_useState14[0],setMessageScroll=_useState14[1];var _useState15=useState(0),_useState16=_slicedToArray(_useState15,2),currentThread=_useState16[0],setCurrentThread=_useState16[1];var _useContext=useContext(MediaContext),user=_useContext.user;var _useChats=useChats(),postMessage=_useChats.postMessage,getUserIds=_useChats.getUserIds,getAllMessages=_useChats.getAllMessages;var _useUsers=useUsers(),getUsernameById=_useUsers.getUsernameById;var _useWindowDimensions=useWindowDimensions(),height=_useWindowDimensions.height;var heightCorrected=height-64;var messagesEndRef=useRef(null);var messagesEndRef2=useRef(null);var scrollToBottom=function scrollToBottom(number){if(number===1){var _messagesEndRef$curre;(_messagesEndRef$curre=messagesEndRef.current)===null||_messagesEndRef$curre===void 0?void 0:_messagesEndRef$curre.scrollIntoView();}else{var _messagesEndRef2$curr;(_messagesEndRef2$curr=messagesEndRef2.current)===null||_messagesEndRef2$curr===void 0?void 0:_messagesEndRef2$curr.scrollIntoView();setMessageScroll(true);}};useEffect(function(){_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee(){return _regeneratorRuntime.wrap(function _callee$(_context){while(1){switch(_context.prev=_context.next){case 0:try{if(loadMore&&!messageScroll){scrollToBottom(2);}else{scrollToBottom(1);}}catch(e){console.log(e.message);}case 1:case\"end\":return _context.stop();}}},_callee);}))();},[messageId]);useEffect(function(){_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee2(){return _regeneratorRuntime.wrap(function _callee2$(_context2){while(1){switch(_context2.prev=_context2.next){case 0:try{if(currentThread!==id){setLoadMore(false);setMessageScroll(false);setMessageAmount(50);}setCurrentThread(id);console.log('messageUpdate');if(messages.length>=50&&!loadMore){setShowButton(true);}else{setShowButton(false);}}catch(e){console.log(e.message);}case 1:case\"end\":return _context2.stop();}}},_callee2);}))();},[messages]);useEffect(function(){_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee3(){var userIds,usernameArray,i,_user,userObject;return _regeneratorRuntime.wrap(function _callee3$(_context3){while(1){switch(_context3.prev=_context3.next){case 0:_context3.prev=0;setUsernames([]);console.log('USERNAMELIST');_context3.next=5;return getUserIds(id);case 5:userIds=_context3.sent;usernameArray=[];i=0;case 8:if(!(i<userIds.length)){_context3.next=17;break;}_context3.next=11;return getUsernameById(userIds[i].user_id);case 11:_user=_context3.sent;userObject={user_id:userIds[i].user_id,username:_user.username};usernameArray.push(userObject);case 14:i++;_context3.next=8;break;case 17:setUsernames(usernameArray);_context3.next=23;break;case 20:_context3.prev=20;_context3.t0=_context3[\"catch\"](0);console.log(_context3.t0.message);case 23:case\"end\":return _context3.stop();}}},_callee3,null,[[0,20]]);}))();},[id]);var handleSubmit=/*#__PURE__*/function(){var _ref5=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee4(event){var tzoffset,localISOTime,messageObject,success,webSocketUpdate;return _regeneratorRuntime.wrap(function _callee4$(_context4){while(1){switch(_context4.prev=_context4.next){case 0:event.preventDefault();tzoffset=new Date().getTimezoneOffset()*60000;localISOTime=new Date(Date.now()-tzoffset).toISOString().slice(0,-1);console.log('TIMEST: ',localISOTime);messageObject=JSON.stringify({contents:message,timestamp:localISOTime,user_id:user,thread_id:id});_context4.next=7;return postMessage(messageObject);case 7:success=_context4.sent;console.log('SUCCESS: ',success);webSocketUpdate={type:'message',contents:message,timestamp:localISOTime,user_id:user,thread_id:id};if(websocket!==undefined){websocket.send(JSON.stringify(webSocketUpdate));}setMessage('');case 12:case\"end\":return _context4.stop();}}},_callee4);}));return function handleSubmit(_x){return _ref5.apply(this,arguments);};}();var loadAllMessages=/*#__PURE__*/function(){var _ref6=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee5(){var amount,allMessages;return _regeneratorRuntime.wrap(function _callee5$(_context5){while(1){switch(_context5.prev=_context5.next){case 0:if(currentThread!==id){setMessageAmount(50);amount=50;}else{amount=messageAmount;}_context5.next=3;return getAllMessages(id);case 3:allMessages=_context5.sent;console.log('MESSAGE AMOUNT',messageAmount,allMessages);allMessages.splice(allMessages.length-amount,amount);setMoreMessages(allMessages);setLoadMore(true);setShowButton(false);case 9:case\"end\":return _context5.stop();}}},_callee5);}));return function loadAllMessages(){return _ref6.apply(this,arguments);};}();return/*#__PURE__*/_jsx(_Fragment,{children:/*#__PURE__*/_jsxs(Grid,{container:true,justify:\"center\",direction:\"column\",style:{height:heightCorrected},children:[/*#__PURE__*/_jsxs(Grid,{item:true,justify:\"center\",style:{padding:'2rem 6rem 1.5rem 6rem',backgroundColor:'#E69A8DFF',height:'90%',overflowX:'hidden',overflowY:'auto'},children:[loadMore&&/*#__PURE__*/_jsxs(List,{children:[moreMessages.map(function(item,index){return/*#__PURE__*/_jsx(Message,{message_id:item.id,user_id:item.user_id,contents:item.contents,timestamp:item.timestamp,setMessageId:setMessageId,usernames:usernames,index:index,messageArray:moreMessages});}),' ',/*#__PURE__*/_jsx(\"div\",{ref:messagesEndRef2})]}),showButton&&/*#__PURE__*/_jsx(Button,{onClick:loadAllMessages,children:\"Load all messages\"}),usernames.length>0&&/*#__PURE__*/_jsxs(List,{children:[messages.map(function(item,index){return/*#__PURE__*/_jsx(Message,{message_id:item.id,user_id:item.user_id,contents:item.contents,timestamp:item.timestamp,setMessageId:setMessageId,usernames:usernames,index:index,messageArray:messages});}),' ',/*#__PURE__*/_jsx(\"div\",{ref:messagesEndRef})]})]}),/*#__PURE__*/_jsx(Grid,{item:true,container:true,justify:\"center\",direction:\"column\",style:{height:'10%',backgroundColor:'lightgray'},children:/*#__PURE__*/_jsx(Grid,{item:true,children:/*#__PURE__*/_jsxs(\"form\",{onSubmit:handleSubmit,children:[/*#__PURE__*/_jsx(TextField,{value:message,variant:\"outlined\",label:\"Say something!\",onInput:function onInput(event){return setMessage(event.target.value);},style:{width:'70%',backgroundColor:'white',borderRadius:'0.5rem'}}),/*#__PURE__*/_jsx(IconButton,{type:\"submit\",color:\"default\",style:{marginTop:'0.15rem'},children:/*#__PURE__*/_jsx(SendIcon,{style:{fill:'#5F4B8BFF'}})})]})})})]})});};export default Thread;","map":{"version":3,"sources":["/Users/tommivainio/Projektit/chatApp/my-app/src/components/thread.tsx"],"names":["Button","Grid","List","TextField","SendIcon","IconButton","useContext","useEffect","useState","MediaContext","useChats","useUsers","Message","useWindowDimensions","useRef","Thread","messages","id","websocket","messageAmount","setMessageAmount","message","setMessage","messageId","setMessageId","showButton","setShowButton","usernames","setUsernames","moreMessages","setMoreMessages","loadMore","setLoadMore","messageScroll","setMessageScroll","currentThread","setCurrentThread","user","postMessage","getUserIds","getAllMessages","getUsernameById","height","heightCorrected","messagesEndRef","messagesEndRef2","scrollToBottom","number","current","scrollIntoView","e","console","log","length","userIds","usernameArray","i","user_id","userObject","username","push","handleSubmit","event","preventDefault","tzoffset","Date","getTimezoneOffset","localISOTime","now","toISOString","slice","messageObject","JSON","stringify","contents","timestamp","thread_id","success","webSocketUpdate","type","undefined","send","loadAllMessages","amount","allMessages","splice","padding","backgroundColor","overflowX","overflowY","map","item","index","target","value","width","borderRadius","marginTop","fill"],"mappings":"meAAA,OAASA,MAAT,CAAiBC,IAAjB,CAAuBC,IAAvB,CAA6BC,SAA7B,KAA8C,mBAA9C,CACA,MAAOC,CAAAA,QAAP,KAAqB,yBAArB,CACA,OAASC,UAAT,KAA2B,mBAA3B,CACA,OAAoBC,UAApB,CAAgCC,SAAhC,CAA2CC,QAA3C,KAA2D,OAA3D,CACA,OAASC,YAAT,KAA6B,0BAA7B,CACA,OAASC,QAAT,CAAmBC,QAAnB,KAAmC,mBAAnC,CACA,MAAOC,CAAAA,OAAP,KAAoB,uBAApB,CACA,MAAOC,CAAAA,mBAAP,KAAgC,+BAAhC,CACA,OAASC,MAAT,KAAuB,OAAvB,C,6IAuBA,GAAMC,CAAAA,MAAM,CAAG,QAATA,CAAAA,MAAS,MAA4E,IAAzEC,CAAAA,QAAyE,MAAzEA,QAAyE,CAA/DC,EAA+D,MAA/DA,EAA+D,CAA3DC,SAA2D,MAA3DA,SAA2D,CAAhDC,aAAgD,MAAhDA,aAAgD,CAAjCC,gBAAiC,MAAjCA,gBAAiC,CACvF,cAA8BZ,QAAQ,CAAC,EAAD,CAAtC,wCAAOa,OAAP,eAAgBC,UAAhB,eACA,eAAkCd,QAAQ,CAAC,CAAD,CAA1C,yCAAOe,SAAP,eAAkBC,YAAlB,eACA,eAAoChB,QAAQ,CAAC,KAAD,CAA5C,yCAAOiB,UAAP,eAAmBC,aAAnB,eACA,eAAkClB,QAAQ,CAAmB,EAAnB,CAA1C,yCAAOmB,SAAP,eAAkBC,YAAlB,eACA,eAAwCpB,QAAQ,CAAkB,EAAlB,CAAhD,0CAAOqB,YAAP,gBAAqBC,eAArB,gBACA,gBAAgCtB,QAAQ,CAAC,KAAD,CAAxC,2CAAOuB,QAAP,gBAAiBC,WAAjB,gBACA,gBAA0CxB,QAAQ,CAAC,KAAD,CAAlD,2CAAOyB,aAAP,gBAAsBC,gBAAtB,gBACA,gBAA0C1B,QAAQ,CAAC,CAAD,CAAlD,2CAAO2B,aAAP,gBAAsBC,gBAAtB,gBACA,gBAAiB9B,UAAU,CAACG,YAAD,CAA3B,CAAQ4B,IAAR,aAAQA,IAAR,CACA,cAAoD3B,QAAQ,EAA5D,CAAQ4B,WAAR,WAAQA,WAAR,CAAqBC,UAArB,WAAqBA,UAArB,CAAiCC,cAAjC,WAAiCA,cAAjC,CACA,cAA4B7B,QAAQ,EAApC,CAAQ8B,eAAR,WAAQA,eAAR,CACA,yBAAmB5B,mBAAmB,EAAtC,CAAQ6B,MAAR,sBAAQA,MAAR,CACA,GAAMC,CAAAA,eAAe,CAAGD,MAAM,CAAG,EAAjC,CACA,GAAME,CAAAA,cAAc,CAAG9B,MAAM,CAAwB,IAAxB,CAA7B,CACA,GAAM+B,CAAAA,eAAe,CAAG/B,MAAM,CAAwB,IAAxB,CAA9B,CAEA,GAAMgC,CAAAA,cAAc,CAAG,QAAjBA,CAAAA,cAAiB,CAACC,MAAD,CAAoB,CACvC,GAAIA,MAAM,GAAK,CAAf,CAAkB,2BACd,uBAAAH,cAAc,CAACI,OAAf,sEAAwBC,cAAxB,GACH,CAFD,IAEO,2BACH,uBAAAJ,eAAe,CAACG,OAAhB,sEAAyBC,cAAzB,GACAf,gBAAgB,CAAC,IAAD,CAAhB,CACH,CACJ,CAPD,CASA3B,SAAS,CAAC,UAAM,CACZ,wDAAC,mIACG,GAAI,CACA,GAAIwB,QAAQ,EAAI,CAACE,aAAjB,CAAgC,CAC5Ba,cAAc,CAAC,CAAD,CAAd,CACH,CAFD,IAEO,CACHA,cAAc,CAAC,CAAD,CAAd,CACH,CACJ,CAAC,MAAOI,CAAP,CAAU,CACRC,OAAO,CAACC,GAAR,CAAYF,CAAC,CAAC7B,OAAd,EACH,CATJ,sDAAD,KAWH,CAZQ,CAYN,CAACE,SAAD,CAZM,CAAT,CAcAhB,SAAS,CAAC,UAAM,CACZ,wDAAC,wIACG,GAAI,CACA,GAAI4B,aAAa,GAAKlB,EAAtB,CAA0B,CACtBe,WAAW,CAAC,KAAD,CAAX,CACAE,gBAAgB,CAAC,KAAD,CAAhB,CACAd,gBAAgB,CAAC,EAAD,CAAhB,CACH,CACDgB,gBAAgB,CAACnB,EAAD,CAAhB,CACAkC,OAAO,CAACC,GAAR,CAAY,eAAZ,EACA,GAAIpC,QAAQ,CAACqC,MAAT,EAAmB,EAAnB,EAAyB,CAACtB,QAA9B,CAAwC,CACpCL,aAAa,CAAC,IAAD,CAAb,CACH,CAFD,IAEO,CACHA,aAAa,CAAC,KAAD,CAAb,CACH,CACJ,CAAC,MAAOwB,CAAP,CAAU,CACRC,OAAO,CAACC,GAAR,CAAYF,CAAC,CAAC7B,OAAd,EACH,CAhBJ,wDAAD,KAkBH,CAnBQ,CAmBN,CAACL,QAAD,CAnBM,CAAT,CAqBAT,SAAS,CAAC,UAAM,CACZ,wDAAC,sMAEOqB,YAAY,CAAC,EAAD,CAAZ,CACAuB,OAAO,CAACC,GAAR,CAAY,cAAZ,EAHP,uBAI6Bb,CAAAA,UAAU,CAACtB,EAAD,CAJvC,QAIaqC,OAJb,gBAKWC,aALX,CAKkD,EALlD,CAMgBC,CANhB,CAMoB,CANpB,aAMuBA,CAAC,CAAGF,OAAO,CAACD,MANnC,oDAO8BZ,CAAAA,eAAe,CAACa,OAAO,CAACE,CAAD,CAAP,CAAWC,OAAZ,CAP7C,SAOiBpB,KAPjB,gBAQiBqB,UARjB,CAQ8B,CACfD,OAAO,CAAEH,OAAO,CAACE,CAAD,CAAP,CAAWC,OADL,CAEfE,QAAQ,CAAEtB,KAAI,CAACsB,QAFA,CAR9B,CAYWJ,aAAa,CAACK,IAAd,CAAmBF,UAAnB,EAZX,QAM2CF,CAAC,EAN5C,gCAcO5B,YAAY,CAAC2B,aAAD,CAAZ,CAdP,qFAiBOJ,OAAO,CAACC,GAAR,CAAY,aAAE/B,OAAd,EAjBP,uEAAD,KAoBH,CArBQ,CAqBN,CAACJ,EAAD,CArBM,CAAT,CAuBA,GAAM4C,CAAAA,YAAY,2FAAG,kBAAOC,KAAP,sLACjBA,KAAK,CAACC,cAAN,GACMC,QAFW,CAEC,GAAIC,CAAAA,IAAJ,EAAD,CAAaC,iBAAb,GAAmC,KAFnC,CAGXC,YAHW,CAGK,GAAIF,CAAAA,IAAJ,CAASA,IAAI,CAACG,GAAL,GAAaJ,QAAtB,CAAD,CAAkCK,WAAlC,GAAgDC,KAAhD,CAAsD,CAAtD,CAAyD,CAAC,CAA1D,CAHJ,CAIjBnB,OAAO,CAACC,GAAR,CAAY,UAAZ,CAAwBe,YAAxB,EACMI,aALW,CAKKC,IAAI,CAACC,SAAL,CAAe,CACjCC,QAAQ,CAAErD,OADuB,CAEjCsD,SAAS,CAAER,YAFsB,CAGjCV,OAAO,CAAEpB,IAHwB,CAIjCuC,SAAS,CAAE3D,EAJsB,CAAf,CALL,wBAYKqB,CAAAA,WAAW,CAACiC,aAAD,CAZhB,QAYXM,OAZW,gBAajB1B,OAAO,CAACC,GAAR,CAAY,WAAZ,CAAyByB,OAAzB,EACMC,eAdW,CAcO,CACpBC,IAAI,CAAE,SADc,CAEpBL,QAAQ,CAAErD,OAFU,CAGpBsD,SAAS,CAAER,YAHS,CAIpBV,OAAO,CAAEpB,IAJW,CAKpBuC,SAAS,CAAE3D,EALS,CAdP,CAqBjB,GAAIC,SAAS,GAAK8D,SAAlB,CAA6B,CACzB9D,SAAS,CAAC+D,IAAV,CAAeT,IAAI,CAACC,SAAL,CAAeK,eAAf,CAAf,EACH,CACDxD,UAAU,CAAC,EAAD,CAAV,CAxBiB,yDAAH,kBAAZuC,CAAAA,YAAY,6CAAlB,CA2BA,GAAMqB,CAAAA,eAAe,2FAAG,+JAEpB,GAAI/C,aAAa,GAAKlB,EAAtB,CAA0B,CACtBG,gBAAgB,CAAC,EAAD,CAAhB,CACA+D,MAAM,CAAG,EAAT,CACH,CAHD,IAGO,CACHA,MAAM,CAAGhE,aAAT,CACH,CAPmB,uBAQMqB,CAAAA,cAAc,CAACvB,EAAD,CARpB,QAQdmE,WARc,gBASpBjC,OAAO,CAACC,GAAR,CAAY,gBAAZ,CAA8BjC,aAA9B,CAA6CiE,WAA7C,EACAA,WAAW,CAACC,MAAZ,CAAmBD,WAAW,CAAC/B,MAAZ,CAAqB8B,MAAxC,CAAgDA,MAAhD,EACArD,eAAe,CAACsD,WAAD,CAAf,CACApD,WAAW,CAAC,IAAD,CAAX,CACAN,aAAa,CAAC,KAAD,CAAb,CAboB,wDAAH,kBAAfwD,CAAAA,eAAe,2CAArB,CAgBA,mBACI,sCACI,MAAC,IAAD,EAAM,SAAS,KAAf,CAAgB,OAAO,CAAC,QAAxB,CAAiC,SAAS,CAAC,QAA3C,CAAoD,KAAK,CAAE,CAAExC,MAAM,CAAEC,eAAV,CAA3D,wBACI,MAAC,IAAD,EAAM,IAAI,KAAV,CAAW,OAAO,CAAC,QAAnB,CAA4B,KAAK,CAC5B,CACG2C,OAAO,CAAE,uBADZ,CAEGC,eAAe,CAAE,WAFpB,CAGG7C,MAAM,CAAE,KAHX,CAIG8C,SAAS,CAAE,QAJd,CAKGC,SAAS,CAAE,MALd,CADL,WAQK1D,QAAQ,eACL,MAAC,IAAD,YACKF,YAAY,CAAC6D,GAAb,CAAiB,SAACC,IAAD,CAAOC,KAAP,qBACd,KAAC,OAAD,EACI,UAAU,CAAED,IAAI,CAAC1E,EADrB,CAEI,OAAO,CAAE0E,IAAI,CAAClC,OAFlB,CAGI,QAAQ,CAAEkC,IAAI,CAACjB,QAHnB,CAII,SAAS,CAAEiB,IAAI,CAAChB,SAJpB,CAKI,YAAY,CAAEnD,YALlB,CAMI,SAAS,CAAEG,SANf,CAOI,KAAK,CAAEiE,KAPX,CAQI,YAAY,CAAE/D,YARlB,EADc,EAAjB,CADL,CAYQ,GAZR,cAaI,YAAK,GAAG,CAAEgB,eAAV,EAbJ,GATR,CAyBKpB,UAAU,eACP,KAAC,MAAD,EAAQ,OAAO,CAAEyD,eAAjB,+BA1BR,CA4BKvD,SAAS,CAAC0B,MAAV,CAAmB,CAAnB,eACG,MAAC,IAAD,YACKrC,QAAQ,CAAC0E,GAAT,CAAa,SAACC,IAAD,CAAOC,KAAP,qBACV,KAAC,OAAD,EACI,UAAU,CAAED,IAAI,CAAC1E,EADrB,CAEI,OAAO,CAAE0E,IAAI,CAAClC,OAFlB,CAGI,QAAQ,CAAEkC,IAAI,CAACjB,QAHnB,CAII,SAAS,CAAEiB,IAAI,CAAChB,SAJpB,CAKI,YAAY,CAAEnD,YALlB,CAMI,SAAS,CAAEG,SANf,CAOI,KAAK,CAAEiE,KAPX,CAQI,YAAY,CAAE5E,QARlB,EADU,EAAb,CADL,CAYQ,GAZR,cAaI,YAAK,GAAG,CAAE4B,cAAV,EAbJ,GA7BR,GADJ,cA+CI,KAAC,IAAD,EAAM,IAAI,KAAV,CAAW,SAAS,KAApB,CAAqB,OAAO,CAAC,QAA7B,CAAsC,SAAS,CAAC,QAAhD,CAAyD,KAAK,CAAE,CAAEF,MAAM,CAAE,KAAV,CAAiB6C,eAAe,CAAE,WAAlC,CAAhE,uBACI,KAAC,IAAD,EAAM,IAAI,KAAV,uBACI,cACI,QAAQ,CAAE1B,YADd,wBAII,KAAC,SAAD,EACI,KAAK,CAAExC,OADX,CAEI,OAAO,CAAC,UAFZ,CAGI,KAAK,CAAC,gBAHV,CAII,OAAO,CAAE,iBAACyC,KAAD,QAAWxC,CAAAA,UAAU,CAAEwC,KAAK,CAAC+B,MAAP,CAAmCC,KAApC,CAArB,EAJb,CAKI,KAAK,CAAE,CAAEC,KAAK,CAAE,KAAT,CAAgBR,eAAe,CAAE,OAAjC,CAA0CS,YAAY,CAAE,QAAxD,CALX,EAJJ,cAWI,KAAC,UAAD,EACI,IAAI,CAAC,QADT,CAEI,KAAK,CAAC,SAFV,CAGI,KAAK,CAAE,CAAEC,SAAS,CAAE,SAAb,CAHX,uBAKI,KAAC,QAAD,EAAU,KAAK,CAAE,CAAEC,IAAI,CAAE,WAAR,CAAjB,EALJ,EAXJ,GADJ,EADJ,EA/CJ,GADJ,EADJ,CA8EH,CA7MD,CA+MA,cAAenF,CAAAA,MAAf","sourcesContent":["import { Button, Grid, List, TextField } from '@material-ui/core';\r\nimport SendIcon from '@material-ui/icons/Send';\r\nimport { IconButton } from '@material-ui/core';\r\nimport { FormEvent, useContext, useEffect, useState } from 'react';\r\nimport { MediaContext } from '../contexts/mediaContext';\r\nimport { useChats, useUsers } from '../hooks/apiHooks';\r\nimport Message from '../components/message';\r\nimport useWindowDimensions from '../hooks/windowDimensionsHook';\r\nimport { useRef } from 'react';\r\n\r\ninterface messagesArray {\r\n    id: number,\r\n    user_id: number,\r\n    contents: string,\r\n    timestamp: Date,\r\n}\r\n\r\ninterface propType {\r\n    messages: messagesArray[],\r\n    id: number,\r\n    websocket: WebSocket | undefined,\r\n    messageAmount: number,\r\n    setMessageAmount: Function,\r\n}\r\n\r\ninterface usernamesArray {\r\n    user_id: number,\r\n    username: string,\r\n}\r\n\r\n\r\nconst Thread = ({ messages, id, websocket, messageAmount, setMessageAmount }: propType) => {\r\n    const [message, setMessage] = useState('');\r\n    const [messageId, setMessageId] = useState(0);\r\n    const [showButton, setShowButton] = useState(false);\r\n    const [usernames, setUsernames] = useState<usernamesArray[]>([])\r\n    const [moreMessages, setMoreMessages] = useState<messagesArray[]>([])\r\n    const [loadMore, setLoadMore] = useState(false);\r\n    const [messageScroll, setMessageScroll] = useState(false);\r\n    const [currentThread, setCurrentThread] = useState(0);\r\n    const { user } = useContext(MediaContext);\r\n    const { postMessage, getUserIds, getAllMessages } = useChats();\r\n    const { getUsernameById } = useUsers();\r\n    const { height } = useWindowDimensions();\r\n    const heightCorrected = height - 64;\r\n    const messagesEndRef = useRef<null | HTMLDivElement>(null)\r\n    const messagesEndRef2 = useRef<null | HTMLDivElement>(null)\r\n\r\n    const scrollToBottom = (number: number) => {\r\n        if (number === 1) {\r\n            messagesEndRef.current?.scrollIntoView()\r\n        } else {\r\n            messagesEndRef2.current?.scrollIntoView()\r\n            setMessageScroll(true);\r\n        }\r\n    }\r\n\r\n    useEffect(() => {\r\n        (async () => {\r\n            try {\r\n                if (loadMore && !messageScroll) {\r\n                    scrollToBottom(2);\r\n                } else {\r\n                    scrollToBottom(1);\r\n                }\r\n            } catch (e) {\r\n                console.log(e.message);\r\n            }\r\n        })();\r\n    }, [messageId]);\r\n\r\n    useEffect(() => {\r\n        (async () => {\r\n            try {\r\n                if (currentThread !== id) {\r\n                    setLoadMore(false);\r\n                    setMessageScroll(false);\r\n                    setMessageAmount(50);\r\n                }\r\n                setCurrentThread(id);\r\n                console.log('messageUpdate')\r\n                if (messages.length >= 50 && !loadMore) {\r\n                    setShowButton(true);\r\n                } else {\r\n                    setShowButton(false);\r\n                }\r\n            } catch (e) {\r\n                console.log(e.message);\r\n            }\r\n        })();\r\n    }, [messages]);\r\n\r\n    useEffect(() => {\r\n        (async () => {\r\n            try {\r\n                setUsernames([]);\r\n                console.log('USERNAMELIST')\r\n                const userIds = await getUserIds(id);\r\n                let usernameArray: Array<usernamesArray> = [];\r\n                for (let i = 0; i < userIds.length; i++) {\r\n                    const user = await getUsernameById(userIds[i].user_id);\r\n                    const userObject = {\r\n                        user_id: userIds[i].user_id,\r\n                        username: user.username\r\n                    }\r\n                    usernameArray.push(userObject);\r\n                }\r\n                setUsernames(usernameArray)\r\n\r\n            } catch (e) {\r\n                console.log(e.message);\r\n            }\r\n        })();\r\n    }, [id]);\r\n\r\n    const handleSubmit = async (event: FormEvent) => {\r\n        event.preventDefault();\r\n        const tzoffset = (new Date()).getTimezoneOffset() * 60000;\r\n        const localISOTime = (new Date(Date.now() - tzoffset)).toISOString().slice(0, -1);\r\n        console.log('TIMEST: ', localISOTime)\r\n        const messageObject = JSON.stringify({\r\n            contents: message,\r\n            timestamp: localISOTime,\r\n            user_id: user,\r\n            thread_id: id,\r\n\r\n        });\r\n        const success = await postMessage(messageObject)\r\n        console.log('SUCCESS: ', success)\r\n        const webSocketUpdate = {\r\n            type: 'message',\r\n            contents: message,\r\n            timestamp: localISOTime,\r\n            user_id: user,\r\n            thread_id: id\r\n        }\r\n        if (websocket !== undefined) {\r\n            websocket.send(JSON.stringify(webSocketUpdate));\r\n        }\r\n        setMessage('');\r\n    };\r\n\r\n    const loadAllMessages = async () => {\r\n        let amount;\r\n        if (currentThread !== id) {\r\n            setMessageAmount(50);\r\n            amount = 50;\r\n        } else {\r\n            amount = messageAmount;\r\n        }\r\n        const allMessages = await getAllMessages(id);\r\n        console.log('MESSAGE AMOUNT', messageAmount, allMessages);\r\n        allMessages.splice(allMessages.length - amount, amount);\r\n        setMoreMessages(allMessages);\r\n        setLoadMore(true);\r\n        setShowButton(false);\r\n    }\r\n\r\n    return (\r\n        <>\r\n            <Grid container justify=\"center\" direction=\"column\" style={{ height: heightCorrected }}>\r\n                <Grid item justify=\"center\" style=\r\n                    {{\r\n                        padding: '2rem 6rem 1.5rem 6rem',\r\n                        backgroundColor: '#E69A8DFF',\r\n                        height: '90%',\r\n                        overflowX: 'hidden',\r\n                        overflowY: 'auto'\r\n                    }}>\r\n                    {loadMore &&\r\n                        <List>\r\n                            {moreMessages.map((item, index) => (\r\n                                <Message\r\n                                    message_id={item.id}\r\n                                    user_id={item.user_id}\r\n                                    contents={item.contents}\r\n                                    timestamp={item.timestamp}\r\n                                    setMessageId={setMessageId}\r\n                                    usernames={usernames}\r\n                                    index={index}\r\n                                    messageArray={moreMessages}\r\n                                />\r\n                            ))}{' '}\r\n                            <div ref={messagesEndRef2} />\r\n                        </List>\r\n                    }\r\n                    {showButton &&\r\n                        <Button onClick={loadAllMessages}>Load all messages</Button>\r\n                    }\r\n                    {usernames.length > 0 &&\r\n                        <List>\r\n                            {messages.map((item, index) => (\r\n                                <Message\r\n                                    message_id={item.id}\r\n                                    user_id={item.user_id}\r\n                                    contents={item.contents}\r\n                                    timestamp={item.timestamp}\r\n                                    setMessageId={setMessageId}\r\n                                    usernames={usernames}\r\n                                    index={index}\r\n                                    messageArray={messages}\r\n                                />\r\n                            ))}{' '}\r\n                            <div ref={messagesEndRef} />\r\n                        </List>\r\n                    }\r\n                </Grid>\r\n                <Grid item container justify=\"center\" direction=\"column\" style={{ height: '10%', backgroundColor: 'lightgray' }}>\r\n                    <Grid item>\r\n                        <form\r\n                            onSubmit={handleSubmit}\r\n                        >\r\n\r\n                            <TextField\r\n                                value={message}\r\n                                variant=\"outlined\"\r\n                                label=\"Say something!\"\r\n                                onInput={(event) => setMessage((event.target as HTMLInputElement).value)}\r\n                                style={{ width: '70%', backgroundColor: 'white', borderRadius: '0.5rem' }}\r\n                            />\r\n                            <IconButton\r\n                                type=\"submit\"\r\n                                color=\"default\"\r\n                                style={{ marginTop: '0.15rem' }}\r\n                            >\r\n                                <SendIcon style={{ fill: '#5F4B8BFF' }} />\r\n                            </IconButton>\r\n\r\n                        </form>\r\n                    </Grid>\r\n                </Grid>\r\n\r\n            </Grid>\r\n\r\n        </>\r\n    )\r\n}\r\n\r\nexport default Thread;"]},"metadata":{},"sourceType":"module"}