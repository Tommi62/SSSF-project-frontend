{"ast":null,"code":"var _jsxFileName = \"/Users/tommivainio/Desktop/chatApp/my-app/src/views/home.tsx\",\n    _s = $RefreshSig$();\n\n/* eslint-disable react-hooks/exhaustive-deps */\nimport { Button, Grid, List, Typography } from '@material-ui/core';\nimport { useContext, useEffect, useState } from 'react';\nimport Thread from '../components/thread';\nimport ThreadButton from '../components/threadButton';\nimport ThreadForm from '../components/threadForm';\nimport { MediaContext } from '../contexts/mediaContext';\nimport { WebsocketContext } from '../contexts/websocketContext';\nimport { useUsers, useChats } from '../hooks/apiHooks';\nimport { jsxDEV as _jsxDEV } from \"react/jsx-dev-runtime\";\nimport { Fragment as _Fragment } from \"react/jsx-dev-runtime\";\n\nconst Home = ({\n  history\n}) => {\n  _s();\n\n  const {\n    user,\n    setUser\n  } = useContext(MediaContext);\n  const {\n    websocket,\n    setWebsocket\n  } = useContext(WebsocketContext);\n  const {\n    getIsLoggedIn\n  } = useUsers();\n  const {\n    getThreadIds,\n    getMessages\n  } = useChats();\n  const [threads, setThreads] = useState([]);\n  const [threadOpen, setThreadOpen] = useState(false);\n  const [threadId, setThreadId] = useState(0);\n  const [messages, setMessages] = useState([]);\n  const [socketThreadId, setSocketThreadId] = useState(0);\n  const [updateState, setUpdateState] = useState(Date.now());\n  const [updateThreadButtons, setUpdateThreadButtons] = useState(Date.now());\n  const [createNewChatThread, setCreateNewChatThread] = useState(false);\n  const [wsMessage, setWsMessage] = useState({\n    type: '',\n    contents: '',\n    timestamp: new Date(),\n    user_id: 0,\n    thread_id: 0\n  });\n  let newMessagesArray = [];\n  useEffect(() => {\n    (async () => {\n      try {\n        console.log('USER: ', user);\n        const isLoggedIn = await getIsLoggedIn();\n\n        if (!isLoggedIn.success) {\n          history.push('/login');\n        }\n\n        setUser(isLoggedIn.id);\n        console.log('Logged user: ', user, isLoggedIn.id);\n\n        if (user !== 0) {\n          const chatThreads = await getThreadIds(isLoggedIn.id);\n          setThreads(chatThreads);\n        }\n      } catch (e) {\n        console.log(e.message);\n      }\n    })();\n  }, [user, updateThreadButtons]);\n  useEffect(() => {\n    (async () => {\n      try {\n        if (threadId !== 0) {\n          const threadMessages = await getMessages(threadId);\n          const reversedArray = threadMessages.reverse();\n          newMessagesArray = reversedArray;\n          setMessages(newMessagesArray);\n        }\n      } catch (e) {\n        console.log(e.message);\n      }\n    })();\n  }, [threadId, updateState]);\n  useEffect(() => {\n    try {\n      if (wsMessage.type !== '' && wsMessage.thread_id === threadId) {\n        const newMessageObject = {\n          id: Date.now(),\n          user_id: wsMessage.user_id,\n          contents: wsMessage.contents,\n          timestamp: wsMessage.timestamp\n        };\n        console.log('NEWMESSAGESARRAY', newMessagesArray);\n        newMessagesArray.push(newMessageObject);\n        const arrayCopy = [...newMessagesArray];\n        setMessages(arrayCopy);\n      }\n    } catch (e) {\n      console.log(e.message);\n    }\n  }, [wsMessage]);\n  useEffect(() => {\n    try {\n      if (threads.length !== 0) {\n        if (websocket === undefined || websocket.readyState === 2 || websocket.readyState === 3) {\n          console.log('READYSTATE ', websocket === null || websocket === void 0 ? void 0 : websocket.readyState);\n          const socket = new WebSocket('ws://localhost:3001');\n          socket.addEventListener('open', function (event) {\n            console.log('Server is opened.');\n            const client = {\n              type: 'client',\n              thread_id: threadId,\n              user_id: user,\n              threads: threads\n            };\n            socket.send(JSON.stringify(client));\n          });\n          socket.addEventListener('message', function (event) {\n            if (event.data !== 'ping') {\n              console.log('Message from server ', JSON.parse(event.data).thread_id);\n              const message = JSON.parse(event.data);\n              console.log('MESSAGETYPE', message.type);\n\n              if (message.type === 'message') {\n                setWsMessage(message);\n                setUpdateThreadButtons(Date.now());\n              } else {\n                setTimeout(() => socket.send('pong'), 1000);\n              }\n            }\n          });\n          socket.addEventListener('close', function (event) {\n            console.log('Websocket connection closed.');\n            setUpdateState(Date.now());\n          });\n          setWebsocket(socket);\n          setSocketThreadId(threadId);\n          console.log('NEW SOCKET');\n        }\n      }\n    } catch (e) {\n      console.log(e.message);\n    }\n\n    ;\n  }, [updateState, threads]);\n\n  const setCreateNewChatThreadOpen = () => {\n    setCreateNewChatThread(true);\n  };\n\n  return /*#__PURE__*/_jsxDEV(_Fragment, {\n    children: createNewChatThread ? /*#__PURE__*/_jsxDEV(ThreadForm, {\n      setCreateNewChatThread: setCreateNewChatThread,\n      setUpdateThreadButtons: setUpdateThreadButtons\n    }, void 0, false, {\n      fileName: _jsxFileName,\n      lineNumber: 159,\n      columnNumber: 17\n    }, this) : /*#__PURE__*/_jsxDEV(_Fragment, {\n      children: threadOpen ? /*#__PURE__*/_jsxDEV(Grid, {\n        container: true,\n        direction: \"row\",\n        children: [/*#__PURE__*/_jsxDEV(Grid, {\n          item: true,\n          style: {\n            width: '30%'\n          },\n          children: /*#__PURE__*/_jsxDEV(Grid, {\n            container: true,\n            style: {\n              borderTop: '1px solid #5F4B8BFF',\n              marginTop: '1rem'\n            },\n            children: /*#__PURE__*/_jsxDEV(List, {\n              style: {\n                padding: 0,\n                width: '100%'\n              },\n              children: [threads.map(item => /*#__PURE__*/_jsxDEV(ThreadButton, {\n                id: item.thread_id,\n                setThreadOpen: setThreadOpen,\n                setThreadId: setThreadId,\n                threadOpen: threadOpen,\n                threadId: threadId\n              }, void 0, false, {\n                fileName: _jsxFileName,\n                lineNumber: 168,\n                columnNumber: 45\n              }, this)), ' ']\n            }, void 0, true, {\n              fileName: _jsxFileName,\n              lineNumber: 166,\n              columnNumber: 37\n            }, this)\n          }, void 0, false, {\n            fileName: _jsxFileName,\n            lineNumber: 165,\n            columnNumber: 33\n          }, this)\n        }, void 0, false, {\n          fileName: _jsxFileName,\n          lineNumber: 164,\n          columnNumber: 29\n        }, this), /*#__PURE__*/_jsxDEV(Grid, {\n          item: true,\n          style: {\n            width: '70%'\n          },\n          children: /*#__PURE__*/_jsxDEV(Thread, {\n            messages: messages,\n            id: threadId,\n            websocket: websocket\n          }, void 0, false, {\n            fileName: _jsxFileName,\n            lineNumber: 174,\n            columnNumber: 33\n          }, this)\n        }, void 0, false, {\n          fileName: _jsxFileName,\n          lineNumber: 173,\n          columnNumber: 29\n        }, this)]\n      }, void 0, true, {\n        fileName: _jsxFileName,\n        lineNumber: 163,\n        columnNumber: 25\n      }, this) : /*#__PURE__*/_jsxDEV(Grid, {\n        container: true,\n        justify: \"center\",\n        direction: \"column\",\n        children: [/*#__PURE__*/_jsxDEV(Typography, {\n          component: \"h1\",\n          variant: \"h2\",\n          children: \"Welcome\"\n        }, void 0, false, {\n          fileName: _jsxFileName,\n          lineNumber: 179,\n          columnNumber: 29\n        }, this), /*#__PURE__*/_jsxDEV(Grid, {\n          container: true,\n          item: true,\n          justifyContent: \"center\",\n          children: /*#__PURE__*/_jsxDEV(Button, {\n            onClick: setCreateNewChatThreadOpen,\n            color: \"primary\",\n            variant: \"contained\",\n            style: {\n              marginTop: '1rem',\n              marginBottom: '1rem'\n            },\n            children: \"Create a new chat thread\"\n          }, void 0, false, {\n            fileName: _jsxFileName,\n            lineNumber: 181,\n            columnNumber: 33\n          }, this)\n        }, void 0, false, {\n          fileName: _jsxFileName,\n          lineNumber: 180,\n          columnNumber: 29\n        }, this), /*#__PURE__*/_jsxDEV(List, {\n          style: {\n            width: '20vw',\n            padding: 0,\n            margin: 'auto',\n            borderStyle: 'solid',\n            borderWidth: '1px 1px 0 1px',\n            borderColor: '#5F4B8BFF'\n          },\n          children: [threads.map(item => /*#__PURE__*/_jsxDEV(ThreadButton, {\n            id: item.thread_id,\n            setThreadOpen: setThreadOpen,\n            setThreadId: setThreadId,\n            threadOpen: threadOpen,\n            threadId: threadId\n          }, void 0, false, {\n            fileName: _jsxFileName,\n            lineNumber: 199,\n            columnNumber: 37\n          }, this)), ' ']\n        }, void 0, true, {\n          fileName: _jsxFileName,\n          lineNumber: 190,\n          columnNumber: 29\n        }, this)]\n      }, void 0, true, {\n        fileName: _jsxFileName,\n        lineNumber: 178,\n        columnNumber: 25\n      }, this)\n    }, void 0, false)\n  }, void 0, false);\n};\n\n_s(Home, \"/V0lpPJH8EbpcWOgw+rA+MvlnzY=\", false, function () {\n  return [useUsers, useChats];\n});\n\n_c = Home;\nexport default Home;\n\nvar _c;\n\n$RefreshReg$(_c, \"Home\");","map":{"version":3,"sources":["/Users/tommivainio/Desktop/chatApp/my-app/src/views/home.tsx"],"names":["Button","Grid","List","Typography","useContext","useEffect","useState","Thread","ThreadButton","ThreadForm","MediaContext","WebsocketContext","useUsers","useChats","Home","history","user","setUser","websocket","setWebsocket","getIsLoggedIn","getThreadIds","getMessages","threads","setThreads","threadOpen","setThreadOpen","threadId","setThreadId","messages","setMessages","socketThreadId","setSocketThreadId","updateState","setUpdateState","Date","now","updateThreadButtons","setUpdateThreadButtons","createNewChatThread","setCreateNewChatThread","wsMessage","setWsMessage","type","contents","timestamp","user_id","thread_id","newMessagesArray","console","log","isLoggedIn","success","push","id","chatThreads","e","message","threadMessages","reversedArray","reverse","newMessageObject","arrayCopy","length","undefined","readyState","socket","WebSocket","addEventListener","event","client","send","JSON","stringify","data","parse","setTimeout","setCreateNewChatThreadOpen","width","borderTop","marginTop","padding","map","item","marginBottom","margin","borderStyle","borderWidth","borderColor"],"mappings":"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","sourcesContent":["/* eslint-disable react-hooks/exhaustive-deps */\nimport { Button, Grid, List, Typography } from '@material-ui/core';\nimport { useContext, useEffect, useState } from 'react';\nimport Thread from '../components/thread';\nimport ThreadButton from '../components/threadButton';\nimport ThreadForm from '../components/threadForm';\nimport { MediaContext } from '../contexts/mediaContext';\nimport { WebsocketContext } from '../contexts/websocketContext';\nimport { useUsers, useChats } from '../hooks/apiHooks';\n\ninterface propType {\n    history: {\n        push: Function,\n    }\n}\n\ninterface threadsArray {\n    thread_id: number\n}\n\ninterface messagesArray {\n    id: number,\n    user_id: number,\n    contents: string,\n    timestamp: Date,\n}\n\nconst Home = ({ history }: propType) => {\n    const { user, setUser } = useContext(MediaContext);\n    const { websocket, setWebsocket } = useContext(WebsocketContext);\n    const { getIsLoggedIn } = useUsers();\n    const { getThreadIds, getMessages } = useChats();\n    const [threads, setThreads] = useState<threadsArray[]>([]);\n    const [threadOpen, setThreadOpen] = useState(false)\n    const [threadId, setThreadId] = useState(0)\n    const [messages, setMessages] = useState<messagesArray[]>([]);\n    const [socketThreadId, setSocketThreadId] = useState(0);\n    const [updateState, setUpdateState] = useState(Date.now());\n    const [updateThreadButtons, setUpdateThreadButtons] = useState(Date.now());\n    const [createNewChatThread, setCreateNewChatThread] = useState(false);\n    const [wsMessage, setWsMessage] = useState({\n        type: '',\n        contents: '',\n        timestamp: new Date(),\n        user_id: 0,\n        thread_id: 0\n    });\n    let newMessagesArray: messagesArray[] = [];\n\n    useEffect(() => {\n        (async () => {\n            try {\n                console.log('USER: ', user)\n                const isLoggedIn = await getIsLoggedIn();\n                if (!isLoggedIn.success) {\n                    history.push('/login');\n                }\n                setUser(isLoggedIn.id)\n                console.log('Logged user: ', user, isLoggedIn.id);\n                if (user !== 0) {\n                    const chatThreads = await getThreadIds(isLoggedIn.id)\n                    setThreads(chatThreads)\n                }\n            } catch (e) {\n                console.log(e.message);\n            }\n        })();\n    }, [user, updateThreadButtons]);\n\n    useEffect(() => {\n        (async () => {\n            try {\n                if (threadId !== 0) {\n                    const threadMessages = await getMessages(threadId);\n                    const reversedArray = threadMessages.reverse();\n                    newMessagesArray = reversedArray;\n                    setMessages(newMessagesArray);\n                }\n            } catch (e) {\n                console.log(e.message);\n            }\n        })();\n    }, [threadId, updateState]);\n\n    useEffect(() => {\n        try {\n            if (wsMessage.type !== '' && wsMessage.thread_id === threadId) {\n                const newMessageObject = {\n                    id: Date.now(),\n                    user_id: wsMessage.user_id,\n                    contents: wsMessage.contents,\n                    timestamp: wsMessage.timestamp,\n                }\n                console.log('NEWMESSAGESARRAY', newMessagesArray);\n                newMessagesArray.push(newMessageObject);\n                const arrayCopy = [...newMessagesArray];\n                setMessages(arrayCopy);\n            }\n        } catch (e) {\n            console.log(e.message);\n        }\n    }, [wsMessage]);\n\n    useEffect(() => {\n        try {\n            if (threads.length !== 0) {\n                if (websocket === undefined || websocket.readyState === 2 || websocket.readyState === 3) {\n                    console.log('READYSTATE ', websocket?.readyState)\n                    const socket = new WebSocket('ws://localhost:3001');\n\n                    socket.addEventListener('open', function (event) {\n                        console.log('Server is opened.');\n                        const client = {\n                            type: 'client',\n                            thread_id: threadId,\n                            user_id: user,\n                            threads: threads,\n                        }\n                        socket.send(JSON.stringify(client));\n                    });\n\n                    socket.addEventListener('message', function (event) {\n                        if (event.data !== 'ping') {\n                            console.log('Message from server ', JSON.parse(event.data).thread_id);\n                            const message = JSON.parse(event.data);\n                            console.log('MESSAGETYPE', message.type);\n                            if (message.type === 'message') {\n                                setWsMessage(message);\n                                setUpdateThreadButtons(Date.now());\n                            } else {\n                                setTimeout(() => socket.send('pong'), 1000);\n                            }\n                        }\n                    });\n\n                    socket.addEventListener('close', function (event) {\n                        console.log('Websocket connection closed.');\n                        setUpdateState(Date.now());\n                    });\n\n                    setWebsocket(socket);\n                    setSocketThreadId(threadId);\n                    console.log('NEW SOCKET');\n                }\n            }\n        } catch (e) {\n            console.log(e.message);\n        };\n    }, [updateState, threads]);\n\n    const setCreateNewChatThreadOpen = () => {\n        setCreateNewChatThread(true);\n    }\n\n\n    return (\n        <>\n            {createNewChatThread ? (\n                <ThreadForm setCreateNewChatThread={setCreateNewChatThread} setUpdateThreadButtons={setUpdateThreadButtons} />\n            ) : (\n                <>\n                    {threadOpen ? (\n                        <Grid container direction=\"row\">\n                            <Grid item style={{ width: '30%' }}>\n                                <Grid container style={{ borderTop: '1px solid #5F4B8BFF', marginTop: '1rem' }} >\n                                    <List style={{ padding: 0, width: '100%' }}>\n                                        {threads.map((item) => (\n                                            <ThreadButton id={item.thread_id} setThreadOpen={setThreadOpen} setThreadId={setThreadId} threadOpen={threadOpen} threadId={threadId} />\n                                        ))}{' '}\n                                    </List>\n                                </Grid>\n                            </Grid>\n                            <Grid item style={{ width: '70%' }}>\n                                <Thread messages={messages} id={threadId} websocket={websocket} />\n                            </Grid>\n                        </Grid>\n                    ) : (\n                        <Grid container justify=\"center\" direction=\"column\">\n                            <Typography component=\"h1\" variant=\"h2\">Welcome</Typography>\n                            <Grid container item justifyContent=\"center\">\n                                <Button\n                                    onClick={setCreateNewChatThreadOpen}\n                                    color=\"primary\"\n                                    variant=\"contained\"\n                                    style={{ marginTop: '1rem', marginBottom: '1rem' }}\n                                >\n                                    Create a new chat thread\n                                </Button>\n                            </Grid>\n                            <List style={{\n                                width: '20vw',\n                                padding: 0,\n                                margin: 'auto',\n                                borderStyle: 'solid',\n                                borderWidth: '1px 1px 0 1px',\n                                borderColor: '#5F4B8BFF'\n                            }}>\n                                {threads.map((item) => (\n                                    <ThreadButton id={item.thread_id} setThreadOpen={setThreadOpen} setThreadId={setThreadId} threadOpen={threadOpen} threadId={threadId} />\n                                ))}{' '}\n                            </List>\n                        </Grid>\n                    )}\n                </>\n            )}\n        </>\n    );\n\n}\n\nexport default Home"]},"metadata":{},"sourceType":"module"}