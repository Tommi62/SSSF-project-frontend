{"ast":null,"code":"var _jsxFileName = \"/Users/tommivainio/Projektit/chatApp/my-app/src/views/home.tsx\",\n    _s = $RefreshSig$();\n\n/* eslint-disable react-hooks/exhaustive-deps */\nimport { Button, Grid, List, Typography } from '@material-ui/core';\nimport { useContext, useEffect, useState } from 'react';\nimport Thread from '../components/thread';\nimport ThreadButton from '../components/threadButton';\nimport Modal from '../components/modal';\nimport { MediaContext } from '../contexts/mediaContext';\nimport { WebsocketContext } from '../contexts/websocketContext';\nimport { useUsers, useChats } from '../hooks/apiHooks';\nimport useWindowDimensions from '../hooks/windowDimensionsHook';\nimport { useMediaQuery } from 'react-responsive';\nimport { makeStyles } from \"@material-ui/core/styles\";\nimport { jsxDEV as _jsxDEV } from \"react/jsx-dev-runtime\";\nimport { Fragment as _Fragment } from \"react/jsx-dev-runtime\";\nconst useStyles = makeStyles(theme => ({\n  container: {\n    [theme.breakpoints.down(600)]: {\n      width: \"85vw!important\",\n      maxHeight: '95vh!important'\n    }\n  }\n}));\n\nconst Home = ({\n  history\n}) => {\n  _s();\n\n  const classes = useStyles();\n  const {\n    user,\n    setUser\n  } = useContext(MediaContext);\n  const {\n    websocket,\n    setWebsocket\n  } = useContext(WebsocketContext);\n  const {\n    getIsLoggedIn\n  } = useUsers();\n  const {\n    getThreadIds,\n    getMessages\n  } = useChats();\n  const {\n    height\n  } = useWindowDimensions();\n  const [heightCorrected, setHeightCorrected] = useState(height - 64);\n  const [threads, setThreads] = useState([]);\n  const [sortedThreads, setSortedThreads] = useState([]);\n  const [threadOpen, setThreadOpen] = useState(false);\n  const [threadId, setThreadId] = useState(0);\n  const [messages, setMessages] = useState([]);\n  const [updateState, setUpdateState] = useState(Date.now());\n  const [updateThreadButtons, setUpdateThreadButtons] = useState(Date.now());\n  const [updateThreadButtonInfos, setUpdateThreadButtonInfos] = useState(Date.now());\n  const [messageAmount, setMessageAmount] = useState(50);\n  const [modalOpen, setModalOpen] = useState(false);\n  const [wsMessage, setWsMessage] = useState({\n    type: '',\n    contents: '',\n    timestamp: new Date(),\n    user_id: 0,\n    thread_id: 0\n  });\n  const isMobile = useMediaQuery({\n    query: '(max-width: 600px)'\n  });\n  useEffect(() => {\n    try {\n      if (isMobile) {\n        setHeightCorrected(height - 56);\n      } else {\n        setHeightCorrected(height - 64);\n      }\n    } catch (e) {\n      console.log(e.message);\n    }\n  }, [isMobile]);\n  useEffect(() => {\n    (async () => {\n      try {\n        console.log('USER: ', user);\n        const isLoggedIn = await getIsLoggedIn();\n\n        if (!isLoggedIn.success) {\n          history.push('/login');\n        }\n\n        setUser(isLoggedIn.id);\n        console.log('Logged user: ', user, isLoggedIn.id);\n\n        if (user !== 0) {\n          const chatThreads = await getThreadIds(isLoggedIn.id);\n          setThreads(chatThreads);\n        }\n      } catch (e) {\n        console.log(e.message);\n      }\n    })();\n  }, [user, updateThreadButtons]);\n  useEffect(() => {\n    (async () => {\n      try {\n        if (threads.length > 0) {\n          let idArray = [];\n\n          for (let i = 0; i < threads.length; i++) {\n            const threadMessages = await getMessages(threads[i].thread_id);\n            const threadIdObject = {\n              id: threads[i].thread_id,\n              timestamp: threadMessages.length > 0 ? threadMessages[0].timestamp : '1999-02-06T05:47:00'\n            };\n            idArray.push(threadIdObject);\n          }\n\n          idArray.sort((a, b) => a.timestamp < b.timestamp ? 1 : b.timestamp < a.timestamp ? -1 : 0);\n          console.log('IDARRAY', idArray);\n          setSortedThreads(idArray);\n        }\n      } catch (e) {\n        console.log(e.message);\n      }\n    })();\n  }, [threads, updateThreadButtonInfos]);\n  useEffect(() => {\n    (async () => {\n      try {\n        if (threadId !== 0) {\n          const threadMessages = await getMessages(threadId);\n          const reversedArray = threadMessages.reverse();\n          setMessages(reversedArray);\n        }\n      } catch (e) {\n        console.log(e.message);\n      }\n    })();\n  }, [threadId, updateState]);\n  useEffect(() => {\n    try {\n      if (wsMessage.type !== '' && wsMessage.thread_id === threadId) {\n        const newMessageObject = {\n          id: Date.now(),\n          user_id: wsMessage.user_id,\n          contents: wsMessage.contents,\n          timestamp: wsMessage.timestamp\n        };\n        setMessages(messages => [...messages, newMessageObject]);\n        setMessageAmount(messageAmount + 1);\n      }\n    } catch (e) {\n      console.log(e.message);\n    }\n  }, [wsMessage]);\n  useEffect(() => {\n    try {\n      if (threads.length !== 0) {\n        if (websocket === undefined || websocket.readyState === 2 || websocket.readyState === 3) {\n          console.log('READYSTATE ', websocket === null || websocket === void 0 ? void 0 : websocket.readyState);\n          const socket = new WebSocket('ws://localhost:3001');\n          socket.addEventListener('open', function (event) {\n            console.log('Server is opened.');\n            const client = {\n              type: 'client',\n              user_id: user,\n              threads: threads\n            };\n            socket.send(JSON.stringify(client));\n          });\n          socket.addEventListener('message', function (event) {\n            if (event.data !== 'ping') {\n              console.log('Message from server ', JSON.parse(event.data).thread_id);\n              const message = JSON.parse(event.data);\n\n              if (message.type === 'message') {\n                setWsMessage(message);\n                setUpdateThreadButtonInfos(Date.now());\n              } else if (message.type === 'newThread') {\n                setUpdateThreadButtons(Date.now());\n              }\n            } else {\n              setTimeout(() => socket.send('pong'), 1000);\n            }\n          });\n          socket.addEventListener('close', function (event) {\n            console.log('Websocket connection closed.');\n            setUpdateState(Date.now());\n          });\n          setWebsocket(socket);\n          console.log('NEW SOCKET');\n        }\n      }\n    } catch (e) {\n      console.log(e.message);\n    }\n\n    ;\n  }, [updateState, threads]);\n\n  const setCreateNewChatThreadOpen = () => {\n    setModalOpen(true);\n  };\n\n  return /*#__PURE__*/_jsxDEV(_Fragment, {\n    children: [isMobile ? /*#__PURE__*/_jsxDEV(Grid, {\n      container: true,\n      direction: \"column\",\n      style: {\n        height: heightCorrected\n      },\n      children: threadOpen ? /*#__PURE__*/_jsxDEV(Grid, {\n        item: true,\n        children: /*#__PURE__*/_jsxDEV(Thread, {\n          messages: messages,\n          id: threadId,\n          websocket: websocket,\n          messageAmount: messageAmount,\n          setMessageAmount: setMessageAmount\n        }, void 0, false, {\n          fileName: _jsxFileName,\n          lineNumber: 218,\n          columnNumber: 29\n        }, this)\n      }, void 0, false, {\n        fileName: _jsxFileName,\n        lineNumber: 217,\n        columnNumber: 25\n      }, this) : /*#__PURE__*/_jsxDEV(Grid, {\n        item: true,\n        children: [/*#__PURE__*/_jsxDEV(Button, {\n          onClick: setCreateNewChatThreadOpen,\n          color: \"primary\",\n          variant: \"contained\",\n          style: {\n            marginTop: '1rem'\n          },\n          children: \"Create a new chat thread\"\n        }, void 0, false, {\n          fileName: _jsxFileName,\n          lineNumber: 222,\n          columnNumber: 29\n        }, this), /*#__PURE__*/_jsxDEV(Grid, {\n          container: true,\n          style: {\n            borderTop: '1px solid #5F4B8BFF',\n            marginTop: '1rem'\n          },\n          children: /*#__PURE__*/_jsxDEV(List, {\n            style: {\n              padding: 0,\n              width: '100vw'\n            },\n            children: [sortedThreads.map(item => /*#__PURE__*/_jsxDEV(ThreadButton, {\n              id: item.id,\n              setThreadOpen: setThreadOpen,\n              setThreadId: setThreadId,\n              threadOpen: threadOpen,\n              threadId: threadId,\n              updateThreadButtonInfos: updateThreadButtonInfos\n            }, void 0, false, {\n              fileName: _jsxFileName,\n              lineNumber: 233,\n              columnNumber: 41\n            }, this)), ' ']\n          }, void 0, true, {\n            fileName: _jsxFileName,\n            lineNumber: 231,\n            columnNumber: 33\n          }, this)\n        }, void 0, false, {\n          fileName: _jsxFileName,\n          lineNumber: 230,\n          columnNumber: 29\n        }, this)]\n      }, void 0, true, {\n        fileName: _jsxFileName,\n        lineNumber: 221,\n        columnNumber: 25\n      }, this)\n    }, void 0, false, {\n      fileName: _jsxFileName,\n      lineNumber: 215,\n      columnNumber: 17\n    }, this) : /*#__PURE__*/_jsxDEV(Grid, {\n      container: true,\n      direction: \"row\",\n      style: {\n        height: heightCorrected\n      },\n      children: [/*#__PURE__*/_jsxDEV(Grid, {\n        item: true,\n        style: {\n          width: '30%',\n          borderRight: '1px solid #5F4B8BFF',\n          maxHeight: heightCorrected,\n          overflowY: 'auto'\n        },\n        children: [/*#__PURE__*/_jsxDEV(Button, {\n          onClick: setCreateNewChatThreadOpen,\n          color: \"primary\",\n          variant: \"contained\",\n          style: {\n            marginTop: '1rem'\n          },\n          children: \"Create a new chat thread\"\n        }, void 0, false, {\n          fileName: _jsxFileName,\n          lineNumber: 250,\n          columnNumber: 25\n        }, this), /*#__PURE__*/_jsxDEV(Grid, {\n          container: true,\n          style: {\n            borderTop: '1px solid #5F4B8BFF',\n            marginTop: '1rem'\n          },\n          children: /*#__PURE__*/_jsxDEV(List, {\n            style: {\n              padding: 0,\n              width: '100%'\n            },\n            children: [sortedThreads.map(item => /*#__PURE__*/_jsxDEV(ThreadButton, {\n              id: item.id,\n              setThreadOpen: setThreadOpen,\n              setThreadId: setThreadId,\n              threadOpen: threadOpen,\n              threadId: threadId,\n              updateThreadButtonInfos: updateThreadButtonInfos\n            }, void 0, false, {\n              fileName: _jsxFileName,\n              lineNumber: 261,\n              columnNumber: 37\n            }, this)), ' ']\n          }, void 0, true, {\n            fileName: _jsxFileName,\n            lineNumber: 259,\n            columnNumber: 29\n          }, this)\n        }, void 0, false, {\n          fileName: _jsxFileName,\n          lineNumber: 258,\n          columnNumber: 25\n        }, this)]\n      }, void 0, true, {\n        fileName: _jsxFileName,\n        lineNumber: 249,\n        columnNumber: 21\n      }, this), /*#__PURE__*/_jsxDEV(Grid, {\n        item: true,\n        style: {\n          width: '70%'\n        },\n        children: threadOpen ? /*#__PURE__*/_jsxDEV(Thread, {\n          messages: messages,\n          id: threadId,\n          websocket: websocket,\n          messageAmount: messageAmount,\n          setMessageAmount: setMessageAmount\n        }, void 0, false, {\n          fileName: _jsxFileName,\n          lineNumber: 275,\n          columnNumber: 29\n        }, this) : /*#__PURE__*/_jsxDEV(Grid, {\n          container: true,\n          alignItems: \"center\",\n          justify: \"center\",\n          direction: \"column\",\n          children: [/*#__PURE__*/_jsxDEV(Typography, {\n            component: \"h1\",\n            variant: \"h2\",\n            children: \"Welcome\"\n          }, void 0, false, {\n            fileName: _jsxFileName,\n            lineNumber: 278,\n            columnNumber: 33\n          }, this), /*#__PURE__*/_jsxDEV(Typography, {\n            component: \"div\",\n            variant: \"body1\",\n            children: \"This is Chat App made by Tommi.\"\n          }, void 0, false, {\n            fileName: _jsxFileName,\n            lineNumber: 279,\n            columnNumber: 33\n          }, this)]\n        }, void 0, true, {\n          fileName: _jsxFileName,\n          lineNumber: 277,\n          columnNumber: 29\n        }, this)\n      }, void 0, false, {\n        fileName: _jsxFileName,\n        lineNumber: 273,\n        columnNumber: 21\n      }, this)]\n    }, void 0, true, {\n      fileName: _jsxFileName,\n      lineNumber: 248,\n      columnNumber: 17\n    }, this), /*#__PURE__*/_jsxDEV(Modal, {\n      modalOpen: modalOpen,\n      setModalOpen: setModalOpen,\n      websocket: websocket,\n      setThreadOpen: setThreadOpen,\n      setThreadId: setThreadId\n    }, void 0, false, {\n      fileName: _jsxFileName,\n      lineNumber: 286,\n      columnNumber: 13\n    }, this)]\n  }, void 0, true);\n};\n\n_s(Home, \"XO3UcLAHbNv/O8FiZX1iTeUWSvM=\", false, function () {\n  return [useStyles, useUsers, useChats, useWindowDimensions, useMediaQuery];\n});\n\n_c = Home;\nexport default Home;\n\nvar _c;\n\n$RefreshReg$(_c, \"Home\");","map":{"version":3,"sources":["/Users/tommivainio/Projektit/chatApp/my-app/src/views/home.tsx"],"names":["Button","Grid","List","Typography","useContext","useEffect","useState","Thread","ThreadButton","Modal","MediaContext","WebsocketContext","useUsers","useChats","useWindowDimensions","useMediaQuery","makeStyles","useStyles","theme","container","breakpoints","down","width","maxHeight","Home","history","classes","user","setUser","websocket","setWebsocket","getIsLoggedIn","getThreadIds","getMessages","height","heightCorrected","setHeightCorrected","threads","setThreads","sortedThreads","setSortedThreads","threadOpen","setThreadOpen","threadId","setThreadId","messages","setMessages","updateState","setUpdateState","Date","now","updateThreadButtons","setUpdateThreadButtons","updateThreadButtonInfos","setUpdateThreadButtonInfos","messageAmount","setMessageAmount","modalOpen","setModalOpen","wsMessage","setWsMessage","type","contents","timestamp","user_id","thread_id","isMobile","query","e","console","log","message","isLoggedIn","success","push","id","chatThreads","length","idArray","i","threadMessages","threadIdObject","sort","a","b","reversedArray","reverse","newMessageObject","undefined","readyState","socket","WebSocket","addEventListener","event","client","send","JSON","stringify","data","parse","setTimeout","setCreateNewChatThreadOpen","marginTop","borderTop","padding","map","item","borderRight","overflowY"],"mappings":"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","sourcesContent":["/* eslint-disable react-hooks/exhaustive-deps */\nimport { Button, Grid, List, Typography } from '@material-ui/core';\nimport { useContext, useEffect, useState } from 'react';\nimport Thread from '../components/thread';\nimport ThreadButton from '../components/threadButton';\nimport Modal from '../components/modal';\nimport { MediaContext } from '../contexts/mediaContext';\nimport { WebsocketContext } from '../contexts/websocketContext';\nimport { useUsers, useChats } from '../hooks/apiHooks';\nimport useWindowDimensions from '../hooks/windowDimensionsHook';\nimport { useMediaQuery } from 'react-responsive';\nimport { makeStyles } from \"@material-ui/core/styles\";\n\nconst useStyles = makeStyles((theme) => ({\n    container: {\n        [theme.breakpoints.down(600)]: {\n            width: \"85vw!important\",\n            maxHeight: '95vh!important',\n        },\n    },\n}));\n\ninterface propType {\n    history: {\n        push: Function,\n    }\n}\n\ninterface threadsArray {\n    thread_id: number\n}\n\ninterface sortedThreadsArray {\n    id: number,\n    timestamp: string,\n}\n\ninterface messagesArray {\n    id: number,\n    user_id: number,\n    contents: string,\n    timestamp: Date,\n}\n\nconst Home = ({ history }: propType) => {\n    const classes = useStyles();\n    const { user, setUser } = useContext(MediaContext);\n    const { websocket, setWebsocket } = useContext(WebsocketContext);\n    const { getIsLoggedIn } = useUsers();\n    const { getThreadIds, getMessages } = useChats();\n    const { height } = useWindowDimensions();\n    const [heightCorrected, setHeightCorrected] = useState(height - 64);\n    const [threads, setThreads] = useState<threadsArray[]>([]);\n    const [sortedThreads, setSortedThreads] = useState<sortedThreadsArray[]>([]);\n    const [threadOpen, setThreadOpen] = useState(false)\n    const [threadId, setThreadId] = useState(0)\n    const [messages, setMessages] = useState<messagesArray[]>([]);\n    const [updateState, setUpdateState] = useState(Date.now());\n    const [updateThreadButtons, setUpdateThreadButtons] = useState(Date.now());\n    const [updateThreadButtonInfos, setUpdateThreadButtonInfos] = useState(Date.now());\n    const [messageAmount, setMessageAmount] = useState(50);\n    const [modalOpen, setModalOpen] = useState(false);\n    const [wsMessage, setWsMessage] = useState({\n        type: '',\n        contents: '',\n        timestamp: new Date(),\n        user_id: 0,\n        thread_id: 0\n    });\n\n    const isMobile = useMediaQuery({\n        query: '(max-width: 600px)'\n    });\n\n    useEffect(() => {\n        try {\n            if (isMobile) {\n                setHeightCorrected(height - 56);\n            } else {\n                setHeightCorrected(height - 64);\n            }\n        } catch (e) {\n            console.log(e.message);\n        }\n    }, [isMobile]);\n\n    useEffect(() => {\n        (async () => {\n            try {\n                console.log('USER: ', user)\n                const isLoggedIn = await getIsLoggedIn();\n                if (!isLoggedIn.success) {\n                    history.push('/login');\n                }\n                setUser(isLoggedIn.id)\n                console.log('Logged user: ', user, isLoggedIn.id);\n                if (user !== 0) {\n                    const chatThreads = await getThreadIds(isLoggedIn.id)\n                    setThreads(chatThreads)\n                }\n            } catch (e) {\n                console.log(e.message);\n            }\n        })();\n    }, [user, updateThreadButtons]);\n\n    useEffect(() => {\n        (async () => {\n            try {\n                if (threads.length > 0) {\n                    let idArray = [];\n                    for (let i = 0; i < threads.length; i++) {\n                        const threadMessages = await getMessages(threads[i].thread_id);\n                        const threadIdObject = {\n                            id: threads[i].thread_id,\n                            timestamp: threadMessages.length > 0 ? threadMessages[0].timestamp : '1999-02-06T05:47:00',\n                        };\n                        idArray.push(threadIdObject);\n                    }\n                    idArray.sort((a, b) => (a.timestamp < b.timestamp) ? 1 : ((b.timestamp < a.timestamp) ? -1 : 0));\n                    console.log('IDARRAY', idArray);\n                    setSortedThreads(idArray);\n                }\n            } catch (e) {\n                console.log(e.message);\n            }\n        })();\n    }, [threads, updateThreadButtonInfos]);\n\n    useEffect(() => {\n        (async () => {\n            try {\n                if (threadId !== 0) {\n                    const threadMessages = await getMessages(threadId);\n                    const reversedArray = threadMessages.reverse();\n                    setMessages(reversedArray);\n                }\n            } catch (e) {\n                console.log(e.message);\n            }\n        })();\n    }, [threadId, updateState]);\n\n    useEffect(() => {\n        try {\n            if (wsMessage.type !== '' && wsMessage.thread_id === threadId) {\n                const newMessageObject = {\n                    id: Date.now(),\n                    user_id: wsMessage.user_id,\n                    contents: wsMessage.contents,\n                    timestamp: wsMessage.timestamp,\n                }\n                setMessages(messages => [...messages, newMessageObject]);\n                setMessageAmount(messageAmount + 1);\n            }\n        } catch (e) {\n            console.log(e.message);\n        }\n    }, [wsMessage]);\n\n    useEffect(() => {\n        try {\n            if (threads.length !== 0) {\n                if (websocket === undefined || websocket.readyState === 2 || websocket.readyState === 3) {\n                    console.log('READYSTATE ', websocket?.readyState)\n                    const socket = new WebSocket('ws://localhost:3001');\n\n                    socket.addEventListener('open', function (event) {\n                        console.log('Server is opened.');\n                        const client = {\n                            type: 'client',\n                            user_id: user,\n                            threads: threads,\n                        }\n                        socket.send(JSON.stringify(client));\n                    });\n\n                    socket.addEventListener('message', function (event) {\n                        if (event.data !== 'ping') {\n                            console.log('Message from server ', JSON.parse(event.data).thread_id);\n                            const message = JSON.parse(event.data);\n                            if (message.type === 'message') {\n                                setWsMessage(message);\n                                setUpdateThreadButtonInfos(Date.now());\n                            } else if (message.type === 'newThread') {\n                                setUpdateThreadButtons(Date.now());\n                            }\n                        } else {\n                            setTimeout(() => socket.send('pong'), 1000);\n                        }\n                    });\n\n                    socket.addEventListener('close', function (event) {\n                        console.log('Websocket connection closed.');\n                        setUpdateState(Date.now());\n                    });\n\n                    setWebsocket(socket);\n                    console.log('NEW SOCKET');\n                }\n            }\n        } catch (e) {\n            console.log(e.message);\n        };\n    }, [updateState, threads]);\n\n    const setCreateNewChatThreadOpen = () => {\n        setModalOpen(true);\n    }\n\n\n    return (\n        <>\n            {isMobile ? (\n                <Grid container direction=\"column\" style={{ height: heightCorrected, }} >\n                    {threadOpen ? (\n                        <Grid item >\n                            <Thread messages={messages} id={threadId} websocket={websocket} messageAmount={messageAmount} setMessageAmount={setMessageAmount} />\n                        </Grid>\n                    ) : (\n                        <Grid item>\n                            <Button\n                                onClick={setCreateNewChatThreadOpen}\n                                color=\"primary\"\n                                variant=\"contained\"\n                                style={{ marginTop: '1rem' }}\n                            >\n                                Create a new chat thread\n                            </Button>\n                            <Grid container style={{ borderTop: '1px solid #5F4B8BFF', marginTop: '1rem' }} >\n                                <List style={{ padding: 0, width: '100vw' }}>\n                                    {sortedThreads.map((item) => (\n                                        <ThreadButton\n                                            id={item.id}\n                                            setThreadOpen={setThreadOpen}\n                                            setThreadId={setThreadId}\n                                            threadOpen={threadOpen}\n                                            threadId={threadId}\n                                            updateThreadButtonInfos={updateThreadButtonInfos}\n                                        />\n                                    ))}{' '}\n                                </List>\n                            </Grid>\n                        </Grid>\n                    )}\n                </Grid>\n            ) : (\n                <Grid container direction=\"row\" style={{ height: heightCorrected, }} >\n                    <Grid item style={{ width: '30%', borderRight: '1px solid #5F4B8BFF', maxHeight: heightCorrected, overflowY: 'auto' }}>\n                        <Button\n                            onClick={setCreateNewChatThreadOpen}\n                            color=\"primary\"\n                            variant=\"contained\"\n                            style={{ marginTop: '1rem' }}\n                        >\n                            Create a new chat thread\n                        </Button>\n                        <Grid container style={{ borderTop: '1px solid #5F4B8BFF', marginTop: '1rem' }} >\n                            <List style={{ padding: 0, width: '100%' }}>\n                                {sortedThreads.map((item) => (\n                                    <ThreadButton\n                                        id={item.id}\n                                        setThreadOpen={setThreadOpen}\n                                        setThreadId={setThreadId}\n                                        threadOpen={threadOpen}\n                                        threadId={threadId}\n                                        updateThreadButtonInfos={updateThreadButtonInfos}\n                                    />\n                                ))}{' '}\n                            </List>\n                        </Grid>\n                    </Grid>\n                    <Grid item style={{ width: '70%' }}>\n                        {threadOpen ? (\n                            <Thread messages={messages} id={threadId} websocket={websocket} messageAmount={messageAmount} setMessageAmount={setMessageAmount} />\n                        ) : (\n                            <Grid container alignItems=\"center\" justify=\"center\" direction=\"column\" >\n                                <Typography component=\"h1\" variant=\"h2\">Welcome</Typography>\n                                <Typography component=\"div\" variant=\"body1\">This is Chat App made by Tommi.</Typography>\n                            </Grid>\n                        )}\n                    </Grid>\n                </Grid>\n            )\n            }\n            <Modal modalOpen={modalOpen} setModalOpen={setModalOpen} websocket={websocket} setThreadOpen={setThreadOpen} setThreadId={setThreadId} />\n        </>\n    );\n\n}\n\nexport default Home"]},"metadata":{},"sourceType":"module"}