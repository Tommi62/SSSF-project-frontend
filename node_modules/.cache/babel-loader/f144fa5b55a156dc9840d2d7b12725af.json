{"ast":null,"code":"import _regeneratorRuntime from\"/Users/tommivainio/Projektit/chatApp/my-app/node_modules/babel-preset-react-app/node_modules/@babel/runtime/regenerator\";import _asyncToGenerator from\"/Users/tommivainio/Projektit/chatApp/my-app/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/asyncToGenerator\";import _slicedToArray from\"/Users/tommivainio/Projektit/chatApp/my-app/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/slicedToArray\";import _defineProperty from\"/Users/tommivainio/Projektit/chatApp/my-app/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/defineProperty\";import{Button,Grid,List,TextField}from'@material-ui/core';import SendIcon from'@material-ui/icons/Send';import{IconButton}from'@material-ui/core';import{useContext,useEffect,useState}from'react';import{makeStyles}from\"@material-ui/core/styles\";import{MediaContext}from'../contexts/mediaContext';import{useChats,useUsers}from'../hooks/apiHooks';import Message from'../components/message';import useWindowDimensions from'../hooks/windowDimensionsHook';import{useRef}from'react';import{useMediaQuery}from'react-responsive';import ArrowBackIcon from'@mui/icons-material/ArrowBack';import{jsx as _jsx}from\"react/jsx-runtime\";import{jsxs as _jsxs}from\"react/jsx-runtime\";import{Fragment as _Fragment}from\"react/jsx-runtime\";var useStyles=makeStyles(function(theme){return{textField:_defineProperty({width:'70%',backgroundColor:'white',borderRadius:'0.5rem'},theme.breakpoints.down(600),{marginTop:'0.27rem'}),sendButton:_defineProperty({marginTop:'0.25rem',padding:'12px 0 12px 12px'},theme.breakpoints.down(600),{marginTop:0}),thread:_defineProperty({padding:'0 6rem',backgroundColor:'#E69A8DFF',height:'90%',overflowX:'hidden',overflowY:'auto'},theme.breakpoints.down(1000),{padding:'0 1rem'}),arrowBack:{position:'absolute',top:'58px',left:0,zIndex:10,padding:0}};});var Thread=function Thread(_ref){var messages=_ref.messages,id=_ref.id,websocket=_ref.websocket,messageAmount=_ref.messageAmount,setMessageAmount=_ref.setMessageAmount,setThreadOpen=_ref.setThreadOpen,setThreadId=_ref.setThreadId;var classes=useStyles();var _useState=useState(''),_useState2=_slicedToArray(_useState,2),message=_useState2[0],setMessage=_useState2[1];var _useState3=useState(0),_useState4=_slicedToArray(_useState3,2),messageId=_useState4[0],setMessageId=_useState4[1];var _useState5=useState(false),_useState6=_slicedToArray(_useState5,2),showButton=_useState6[0],setShowButton=_useState6[1];var _useState7=useState([]),_useState8=_slicedToArray(_useState7,2),usernames=_useState8[0],setUsernames=_useState8[1];var _useState9=useState([]),_useState10=_slicedToArray(_useState9,2),moreMessages=_useState10[0],setMoreMessages=_useState10[1];var _useState11=useState(false),_useState12=_slicedToArray(_useState11,2),loadMore=_useState12[0],setLoadMore=_useState12[1];var _useState13=useState(false),_useState14=_slicedToArray(_useState13,2),messageScroll=_useState14[0],setMessageScroll=_useState14[1];var _useState15=useState(0),_useState16=_slicedToArray(_useState15,2),currentThread=_useState16[0],setCurrentThread=_useState16[1];var _useContext=useContext(MediaContext),user=_useContext.user;var _useChats=useChats(),postMessage=_useChats.postMessage,getUserIds=_useChats.getUserIds,getAllMessages=_useChats.getAllMessages;var _useUsers=useUsers(),getUsernameById=_useUsers.getUsernameById;var _useWindowDimensions=useWindowDimensions(),height=_useWindowDimensions.height;var _useState17=useState(height-64),_useState18=_slicedToArray(_useState17,2),heightCorrected=_useState18[0],setHeightCorrected=_useState18[1];var messagesEndRef=useRef(null);var messagesEndRef2=useRef(null);var isMobile=useMediaQuery({query:'(max-width: 600px)'});useEffect(function(){try{if(isMobile){setHeightCorrected(height-56);}else{setHeightCorrected(height-64);}}catch(e){console.log(e.message);}},[isMobile]);var scrollToBottom=function scrollToBottom(number){if(number===1){var _messagesEndRef$curre;(_messagesEndRef$curre=messagesEndRef.current)===null||_messagesEndRef$curre===void 0?void 0:_messagesEndRef$curre.scrollIntoView();}else{var _messagesEndRef2$curr;(_messagesEndRef2$curr=messagesEndRef2.current)===null||_messagesEndRef2$curr===void 0?void 0:_messagesEndRef2$curr.scrollIntoView();setMessageScroll(true);}};useEffect(function(){_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee(){return _regeneratorRuntime.wrap(function _callee$(_context){while(1){switch(_context.prev=_context.next){case 0:try{if(loadMore&&!messageScroll){scrollToBottom(2);}else{scrollToBottom(1);}}catch(e){console.log(e.message);}case 1:case\"end\":return _context.stop();}}},_callee);}))();},[messageId]);useEffect(function(){_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee2(){return _regeneratorRuntime.wrap(function _callee2$(_context2){while(1){switch(_context2.prev=_context2.next){case 0:try{if(currentThread!==id){setLoadMore(false);setMessageScroll(false);setMessageAmount(50);}setCurrentThread(id);console.log('messageUpdate');if(messages.length>=50&&!loadMore){setShowButton(true);}else{setShowButton(false);}}catch(e){console.log(e.message);}case 1:case\"end\":return _context2.stop();}}},_callee2);}))();},[messages]);useEffect(function(){_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee3(){var userIds,usernameArray,i,_user,userObject;return _regeneratorRuntime.wrap(function _callee3$(_context3){while(1){switch(_context3.prev=_context3.next){case 0:_context3.prev=0;setUsernames([]);console.log('USERNAMELIST');_context3.next=5;return getUserIds(id);case 5:userIds=_context3.sent;usernameArray=[];i=0;case 8:if(!(i<userIds.length)){_context3.next=17;break;}_context3.next=11;return getUsernameById(userIds[i].user_id);case 11:_user=_context3.sent;userObject={user_id:userIds[i].user_id,username:_user.username};usernameArray.push(userObject);case 14:i++;_context3.next=8;break;case 17:setUsernames(usernameArray);_context3.next=23;break;case 20:_context3.prev=20;_context3.t0=_context3[\"catch\"](0);console.log(_context3.t0.message);case 23:case\"end\":return _context3.stop();}}},_callee3,null,[[0,20]]);}))();},[id]);var handleSubmit=/*#__PURE__*/function(){var _ref5=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee4(event){var tzoffset,localISOTime,messageObject,success,webSocketUpdate;return _regeneratorRuntime.wrap(function _callee4$(_context4){while(1){switch(_context4.prev=_context4.next){case 0:event.preventDefault();_context4.prev=1;if(!(message!=='')){_context4.next=14;break;}tzoffset=new Date().getTimezoneOffset()*60000;localISOTime=new Date(Date.now()-tzoffset).toISOString().slice(0,-1);console.log('TIMEST: ',localISOTime);messageObject=JSON.stringify({contents:message,timestamp:localISOTime,user_id:user,thread_id:id});_context4.next=9;return postMessage(messageObject);case 9:success=_context4.sent;console.log('SUCCESS: ',success);webSocketUpdate={type:'message',contents:message,timestamp:localISOTime,user_id:user,thread_id:id};if(websocket!==undefined){websocket.send(JSON.stringify(webSocketUpdate));}setMessage('');case 14:_context4.next=19;break;case 16:_context4.prev=16;_context4.t0=_context4[\"catch\"](1);console.log(_context4.t0.message);case 19:case\"end\":return _context4.stop();}}},_callee4,null,[[1,16]]);}));return function handleSubmit(_x){return _ref5.apply(this,arguments);};}();var loadAllMessages=/*#__PURE__*/function(){var _ref6=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee5(){var amount,allMessages;return _regeneratorRuntime.wrap(function _callee5$(_context5){while(1){switch(_context5.prev=_context5.next){case 0:_context5.prev=0;if(currentThread!==id){setMessageAmount(50);amount=50;}else{amount=messageAmount;}_context5.next=4;return getAllMessages(id);case 4:allMessages=_context5.sent;console.log('MESSAGE AMOUNT',messageAmount,allMessages);allMessages.splice(allMessages.length-amount,amount);setMoreMessages(allMessages);setLoadMore(true);setShowButton(false);_context5.next=15;break;case 12:_context5.prev=12;_context5.t0=_context5[\"catch\"](0);console.log(_context5.t0.message);case 15:case\"end\":return _context5.stop();}}},_callee5,null,[[0,12]]);}));return function loadAllMessages(){return _ref6.apply(this,arguments);};}();var closeThread=function closeThread(){try{setThreadOpen(false);setThreadId(0);}catch(e){console.log(e.message);}};return/*#__PURE__*/_jsxs(_Fragment,{children:[isMobile&&/*#__PURE__*/_jsxs(Button,{className:classes.arrowBack,onClick:closeThread,children:[/*#__PURE__*/_jsx(ArrowBackIcon,{}),\" Back\"]}),/*#__PURE__*/_jsxs(Grid,{container:true,justify:\"center\",direction:\"column\",style:{height:heightCorrected},children:[/*#__PURE__*/_jsxs(Grid,{item:true,justify:\"center\",className:classes.thread,children:[loadMore&&/*#__PURE__*/_jsxs(List,{children:[moreMessages.map(function(item,index){return/*#__PURE__*/_jsx(Message,{message_id:item.id,user_id:item.user_id,contents:item.contents,timestamp:item.timestamp,setMessageId:setMessageId,usernames:usernames,index:index,messageArray:moreMessages});}),' ',/*#__PURE__*/_jsx(\"div\",{ref:messagesEndRef2})]}),showButton&&/*#__PURE__*/_jsx(Button,{onClick:loadAllMessages,children:\"Load all messages\"}),usernames.length>0&&/*#__PURE__*/_jsxs(List,{children:[messages.map(function(item,index){return/*#__PURE__*/_jsx(Message,{message_id:item.id,user_id:item.user_id,contents:item.contents,timestamp:item.timestamp,setMessageId:setMessageId,usernames:usernames,index:index,messageArray:messages});}),' ',/*#__PURE__*/_jsx(\"div\",{ref:messagesEndRef})]})]}),/*#__PURE__*/_jsx(Grid,{item:true,container:true,justify:\"center\",direction:\"column\",style:{height:'10%',backgroundColor:'lightgray'},children:/*#__PURE__*/_jsx(Grid,{item:true,children:/*#__PURE__*/_jsxs(\"form\",{onSubmit:handleSubmit,children:[isMobile?/*#__PURE__*/_jsx(TextField,{value:message,variant:\"outlined\",label:\"Say something!\",onInput:function onInput(event){return setMessage(event.target.value);},className:classes.textField,size:\"small\"}):/*#__PURE__*/_jsx(TextField,{value:message,variant:\"outlined\",label:\"Say something!\",onInput:function onInput(event){return setMessage(event.target.value);},className:classes.textField}),/*#__PURE__*/_jsx(IconButton,{type:\"submit\",color:\"default\",className:classes.sendButton,children:/*#__PURE__*/_jsx(SendIcon,{style:{fill:'#5F4B8BFF'}})})]})})})]})]});};export default Thread;","map":{"version":3,"sources":["/Users/tommivainio/Projektit/chatApp/my-app/src/components/thread.tsx"],"names":["Button","Grid","List","TextField","SendIcon","IconButton","useContext","useEffect","useState","makeStyles","MediaContext","useChats","useUsers","Message","useWindowDimensions","useRef","useMediaQuery","ArrowBackIcon","useStyles","theme","textField","width","backgroundColor","borderRadius","breakpoints","down","marginTop","sendButton","padding","thread","height","overflowX","overflowY","arrowBack","position","top","left","zIndex","Thread","messages","id","websocket","messageAmount","setMessageAmount","setThreadOpen","setThreadId","classes","message","setMessage","messageId","setMessageId","showButton","setShowButton","usernames","setUsernames","moreMessages","setMoreMessages","loadMore","setLoadMore","messageScroll","setMessageScroll","currentThread","setCurrentThread","user","postMessage","getUserIds","getAllMessages","getUsernameById","heightCorrected","setHeightCorrected","messagesEndRef","messagesEndRef2","isMobile","query","e","console","log","scrollToBottom","number","current","scrollIntoView","length","userIds","usernameArray","i","user_id","userObject","username","push","handleSubmit","event","preventDefault","tzoffset","Date","getTimezoneOffset","localISOTime","now","toISOString","slice","messageObject","JSON","stringify","contents","timestamp","thread_id","success","webSocketUpdate","type","undefined","send","loadAllMessages","amount","allMessages","splice","closeThread","map","item","index","target","value","fill"],"mappings":"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","sourcesContent":["import { Button, Grid, List, TextField } from '@material-ui/core';\r\nimport SendIcon from '@material-ui/icons/Send';\r\nimport { IconButton } from '@material-ui/core';\r\nimport { FormEvent, useContext, useEffect, useState } from 'react';\r\nimport { makeStyles } from \"@material-ui/core/styles\";\r\nimport { MediaContext } from '../contexts/mediaContext';\r\nimport { useChats, useUsers } from '../hooks/apiHooks';\r\nimport Message from '../components/message';\r\nimport useWindowDimensions from '../hooks/windowDimensionsHook';\r\nimport { useRef } from 'react';\r\nimport { useMediaQuery } from 'react-responsive';\r\nimport ArrowBackIcon from '@mui/icons-material/ArrowBack';\r\n\r\nconst useStyles = makeStyles((theme) => ({\r\n    textField: {\r\n        width: '70%',\r\n        backgroundColor: 'white',\r\n        borderRadius: '0.5rem',\r\n        [theme.breakpoints.down(600)]: {\r\n            marginTop: '0.27rem'\r\n        },\r\n    },\r\n    sendButton: {\r\n        marginTop: '0.25rem',\r\n        padding: '12px 0 12px 12px',\r\n        [theme.breakpoints.down(600)]: {\r\n            marginTop: 0\r\n        },\r\n    },\r\n    thread: {\r\n        padding: '0 6rem',\r\n        backgroundColor: '#E69A8DFF',\r\n        height: '90%',\r\n        overflowX: 'hidden',\r\n        overflowY: 'auto',\r\n        [theme.breakpoints.down(1000)]: {\r\n            padding: '0 1rem',\r\n        },\r\n    },\r\n    arrowBack: {\r\n        position: 'absolute',\r\n        top: '58px',\r\n        left: 0,\r\n        zIndex: 10,\r\n        padding: 0,\r\n    }\r\n}));\r\n\r\ninterface messagesArray {\r\n    id: number,\r\n    user_id: number,\r\n    contents: string,\r\n    timestamp: Date,\r\n}\r\n\r\ninterface propType {\r\n    messages: messagesArray[],\r\n    id: number,\r\n    websocket: WebSocket | undefined,\r\n    messageAmount: number,\r\n    setMessageAmount: Function,\r\n    setThreadOpen: Function,\r\n    setThreadId: Function,\r\n}\r\n\r\ninterface usernamesArray {\r\n    user_id: number,\r\n    username: string,\r\n}\r\n\r\n\r\nconst Thread = ({ messages, id, websocket, messageAmount, setMessageAmount, setThreadOpen, setThreadId }: propType) => {\r\n    const classes = useStyles();\r\n    const [message, setMessage] = useState('');\r\n    const [messageId, setMessageId] = useState(0);\r\n    const [showButton, setShowButton] = useState(false);\r\n    const [usernames, setUsernames] = useState<usernamesArray[]>([])\r\n    const [moreMessages, setMoreMessages] = useState<messagesArray[]>([])\r\n    const [loadMore, setLoadMore] = useState(false);\r\n    const [messageScroll, setMessageScroll] = useState(false);\r\n    const [currentThread, setCurrentThread] = useState(0);\r\n    const { user } = useContext(MediaContext);\r\n    const { postMessage, getUserIds, getAllMessages } = useChats();\r\n    const { getUsernameById } = useUsers();\r\n    const { height } = useWindowDimensions();\r\n    const [heightCorrected, setHeightCorrected] = useState(height - 64);\r\n    const messagesEndRef = useRef<null | HTMLDivElement>(null)\r\n    const messagesEndRef2 = useRef<null | HTMLDivElement>(null)\r\n\r\n    const isMobile = useMediaQuery({\r\n        query: '(max-width: 600px)'\r\n    });\r\n\r\n    useEffect(() => {\r\n        try {\r\n            if (isMobile) {\r\n                setHeightCorrected(height - 56);\r\n            } else {\r\n                setHeightCorrected(height - 64);\r\n            }\r\n        } catch (e) {\r\n            console.log(e.message);\r\n        }\r\n    }, [isMobile]);\r\n\r\n    const scrollToBottom = (number: number) => {\r\n        if (number === 1) {\r\n            messagesEndRef.current?.scrollIntoView()\r\n        } else {\r\n            messagesEndRef2.current?.scrollIntoView()\r\n            setMessageScroll(true);\r\n        }\r\n    }\r\n\r\n    useEffect(() => {\r\n        (async () => {\r\n            try {\r\n                if (loadMore && !messageScroll) {\r\n                    scrollToBottom(2);\r\n                } else {\r\n                    scrollToBottom(1);\r\n                }\r\n            } catch (e) {\r\n                console.log(e.message);\r\n            }\r\n        })();\r\n    }, [messageId]);\r\n\r\n    useEffect(() => {\r\n        (async () => {\r\n            try {\r\n                if (currentThread !== id) {\r\n                    setLoadMore(false);\r\n                    setMessageScroll(false);\r\n                    setMessageAmount(50);\r\n                }\r\n                setCurrentThread(id);\r\n                console.log('messageUpdate')\r\n                if (messages.length >= 50 && !loadMore) {\r\n                    setShowButton(true);\r\n                } else {\r\n                    setShowButton(false);\r\n                }\r\n            } catch (e) {\r\n                console.log(e.message);\r\n            }\r\n        })();\r\n    }, [messages]);\r\n\r\n    useEffect(() => {\r\n        (async () => {\r\n            try {\r\n                setUsernames([]);\r\n                console.log('USERNAMELIST')\r\n                const userIds = await getUserIds(id);\r\n                let usernameArray: Array<usernamesArray> = [];\r\n                for (let i = 0; i < userIds.length; i++) {\r\n                    const user = await getUsernameById(userIds[i].user_id);\r\n                    const userObject = {\r\n                        user_id: userIds[i].user_id,\r\n                        username: user.username\r\n                    }\r\n                    usernameArray.push(userObject);\r\n                }\r\n                setUsernames(usernameArray)\r\n\r\n            } catch (e) {\r\n                console.log(e.message);\r\n            }\r\n        })();\r\n    }, [id]);\r\n\r\n    const handleSubmit = async (event: FormEvent) => {\r\n        event.preventDefault();\r\n        try {\r\n            if (message !== '') {\r\n                const tzoffset = (new Date()).getTimezoneOffset() * 60000;\r\n                const localISOTime = (new Date(Date.now() - tzoffset)).toISOString().slice(0, -1);\r\n                console.log('TIMEST: ', localISOTime)\r\n                const messageObject = JSON.stringify({\r\n                    contents: message,\r\n                    timestamp: localISOTime,\r\n                    user_id: user,\r\n                    thread_id: id,\r\n\r\n                });\r\n                const success = await postMessage(messageObject)\r\n                console.log('SUCCESS: ', success)\r\n                const webSocketUpdate = {\r\n                    type: 'message',\r\n                    contents: message,\r\n                    timestamp: localISOTime,\r\n                    user_id: user,\r\n                    thread_id: id\r\n                }\r\n                if (websocket !== undefined) {\r\n                    websocket.send(JSON.stringify(webSocketUpdate));\r\n                }\r\n                setMessage('');\r\n            }\r\n        } catch (e) {\r\n            console.log(e.message);\r\n        }\r\n    };\r\n\r\n    const loadAllMessages = async () => {\r\n        try {\r\n            let amount;\r\n            if (currentThread !== id) {\r\n                setMessageAmount(50);\r\n                amount = 50;\r\n            } else {\r\n                amount = messageAmount;\r\n            }\r\n            const allMessages = await getAllMessages(id);\r\n            console.log('MESSAGE AMOUNT', messageAmount, allMessages);\r\n            allMessages.splice(allMessages.length - amount, amount);\r\n            setMoreMessages(allMessages);\r\n            setLoadMore(true);\r\n            setShowButton(false);\r\n        } catch (e) {\r\n            console.log(e.message);\r\n        }\r\n    };\r\n\r\n    const closeThread = () => {\r\n        try {\r\n            setThreadOpen(false);\r\n            setThreadId(0);\r\n        } catch (e) {\r\n            console.log(e.message);\r\n        }\r\n    };\r\n\r\n    return (\r\n        <>\r\n            {isMobile &&\r\n                <Button className={classes.arrowBack} onClick={closeThread}>\r\n                    <ArrowBackIcon /> Back\r\n                </Button>\r\n            }\r\n            <Grid container justify=\"center\" direction=\"column\" style={{ height: heightCorrected }}>\r\n                <Grid item justify=\"center\" className={classes.thread}>\r\n                    {loadMore &&\r\n                        <List>\r\n                            {moreMessages.map((item, index) => (\r\n                                <Message\r\n                                    message_id={item.id}\r\n                                    user_id={item.user_id}\r\n                                    contents={item.contents}\r\n                                    timestamp={item.timestamp}\r\n                                    setMessageId={setMessageId}\r\n                                    usernames={usernames}\r\n                                    index={index}\r\n                                    messageArray={moreMessages}\r\n                                />\r\n                            ))}{' '}\r\n                            <div ref={messagesEndRef2} />\r\n                        </List>\r\n                    }\r\n                    {showButton &&\r\n                        <Button onClick={loadAllMessages}>Load all messages</Button>\r\n                    }\r\n                    {usernames.length > 0 &&\r\n                        <List>\r\n                            {messages.map((item, index) => (\r\n                                <Message\r\n                                    message_id={item.id}\r\n                                    user_id={item.user_id}\r\n                                    contents={item.contents}\r\n                                    timestamp={item.timestamp}\r\n                                    setMessageId={setMessageId}\r\n                                    usernames={usernames}\r\n                                    index={index}\r\n                                    messageArray={messages}\r\n                                />\r\n                            ))}{' '}\r\n                            <div ref={messagesEndRef} />\r\n                        </List>\r\n                    }\r\n                </Grid>\r\n                <Grid item container justify=\"center\" direction=\"column\" style={{ height: '10%', backgroundColor: 'lightgray' }}>\r\n                    <Grid item>\r\n                        <form\r\n                            onSubmit={handleSubmit}\r\n                        >\r\n                            {isMobile ? (\r\n                                <TextField\r\n                                    value={message}\r\n                                    variant=\"outlined\"\r\n                                    label=\"Say something!\"\r\n                                    onInput={(event) => setMessage((event.target as HTMLInputElement).value)}\r\n                                    className={classes.textField}\r\n                                    size=\"small\"\r\n                                />\r\n                            ) : (\r\n                                <TextField\r\n                                    value={message}\r\n                                    variant=\"outlined\"\r\n                                    label=\"Say something!\"\r\n                                    onInput={(event) => setMessage((event.target as HTMLInputElement).value)}\r\n                                    className={classes.textField}\r\n                                />\r\n                            )}\r\n                            <IconButton\r\n                                type=\"submit\"\r\n                                color=\"default\"\r\n                                className={classes.sendButton}\r\n                            >\r\n                                <SendIcon style={{ fill: '#5F4B8BFF' }} />\r\n                            </IconButton>\r\n\r\n                        </form>\r\n                    </Grid>\r\n                </Grid>\r\n\r\n            </Grid>\r\n\r\n        </>\r\n    )\r\n}\r\n\r\nexport default Thread;"]},"metadata":{},"sourceType":"module"}